---
title: "Dithwa Storm Impact: Weather Data Monitoring & Analysis Dashboard"
subtitle: "Note: Read ABOUT panel to see the description"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
library(flexdashboard)
library(tidyverse)
library(Ditwah)
library(plotly)
data(weather_report)
```

# Meteorological Station

Data source: Department of Meteorology, Sri Lanka (Weather Report for the 24-hour Period). Refer to the ABOUT section for additional details. 

```{r, fig.height=10}
weather_order_28 <-
  weather_report |>
  filter(Type == "Meteorological Station",
         Reporting_Time == "for the 24 hour period ending at 0830SLTS on 28-11-2025") |>
  mutate(Daily_Rainfall_mm = as.numeric(Daily_Rainfall_mm)) |>
  arrange(desc(Daily_Rainfall_mm)) |>
  pull(Name)


all_stations <- weather_report |>
  filter(Type == "Meteorological Station") |>
  pull(Name) |>
  unique()

new_stations <- setdiff(all_stations, weather_order_28)

# Final order: 28-Nov ordered stations first, new ones appended
weather_order <- c(weather_order_28, new_stations)

p1 <- weather_report |>
  filter(Type == "Meteorological Station") |>
  mutate(
    Daily_Rainfall_mm = as.numeric(Daily_Rainfall_mm),
    Name = factor(Name, levels = weather_order)
  ) |>
  ggplot(aes(
    x = Name,
    y = Daily_Rainfall_mm,
    fill = Reporting_Time
  )) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(values = c("#56147DFF", "#E76E5BFF")) +
  labs(
    title = "Comparison of Daily Rainfall: 28 Nov 2025 vs 29 Nov 2025",
    x = "Meteorological Station",
    y = "Rainfall (mm)",
    fill = "Reporting Time",
    caption = "Data source: Department of Meteorology, Sri Lanka (Weather Report for the 24hour Period)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = "bottom"
  )


ggplotly(p1)

```



# Hydro Catchment Area

Data source: Department of Meteorology, Sri Lanka (Weather Report for the 24-hour Period). Refer to the ABOUT section for additional details. 

```{r, fig.width=20}
weather_order_28_h <-
  weather_report |>
  filter(Type == "Hydro Catchment Area",
         Reporting_Time == "for the 24 hour period ending at 0830SLTS on 28-11-2025") |>
  mutate(Daily_Rainfall_mm = as.numeric(Daily_Rainfall_mm)) |>
  arrange(desc(Daily_Rainfall_mm)) |>
  pull(Name)


all_stations_h <- weather_report |>
  filter(Type == "Hydro Catchment Area") |>
  pull(Name) |>
  unique()

new_stations_h <- setdiff(all_stations_h, weather_order_28_h)

# Final order: 28-Nov ordered stations first, new ones appended
weather_order_h <- c(weather_order_28_h, new_stations_h)

p2 <- weather_report |>
  filter(Type == "Hydro Catchment Area") |>
  mutate(
    Daily_Rainfall_mm = as.numeric(Daily_Rainfall_mm),
    Name = factor(Name, levels = weather_order_h)
  ) |>
  ggplot(aes(
    x = Name,
    y = Daily_Rainfall_mm,
    fill = Reporting_Time
  )) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(values = c("#440154", "#21918c")) +
  labs(
    title = "Comparison of Daily Rainfall: 28 Nov 2025 vs 29 Nov 2025",
    x = "Meteorological Station",
    y = "Rainfall (mm)",
    fill = "Reporting Time",
    caption = "Data source: Department of Meteorology, Sri Lanka (Weather Report for the 24hour Period)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = "bottom"
  )


ggplotly(p2)

```

# Other rainfall stations

Data source: Department of Meteorology, Sri Lanka (Weather Report for the 24-hour Period). Refer to the ABOUT section for additional details. 

```{r, fig.width=20}
weather_order_28_o <-
  weather_report |>
  filter(Type == "Other rainfall stations",
         Reporting_Time == "for the 24 hour period ending at 0830SLTS on 28-11-2025") |>
  mutate(Daily_Rainfall_mm = as.numeric(Daily_Rainfall_mm)) |>
  arrange(desc(Daily_Rainfall_mm)) |>
  pull(Name)


all_stations_o <- weather_report |>
  filter(Type == "Other rainfall stations") |>
  pull(Name) |>
  unique()

new_stations_o <- setdiff(all_stations_o, weather_order_28_o)

# Final order: 28-Nov ordered stations first, new ones appended
weather_order_o <- c(weather_order_28_o, new_stations_o)

p3 <- weather_report |>
  filter(Type == "Other rainfall stations") |>
  mutate(
    Daily_Rainfall_mm = as.numeric(Daily_Rainfall_mm),
    Name = factor(Name, levels = weather_order_o)
  ) |>
  ggplot(aes(
    x = Name,
    y = Daily_Rainfall_mm,
    fill = Reporting_Time
  )) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(values = c("#0d0887", "#FFA500")) +
  labs(
    title = "Comparison of Daily Rainfall: 28 Nov 2025 vs 29 Nov 2025",
    x = "Meteorological Station",
    y = "Rainfall (mm)",
    fill = "Reporting Time",
    caption = "Data source: Department of Meteorology, Sri Lanka (Weather Report for the 24hour Period)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = "bottom"
  )


ggplotly(p3)

```

# Flood Level Data: Kelani Ganga (RB 01)

Data Source: Hydrology and Disaster Management Division, Irrigation Department, Sri Lanka



```{r, fig.width=15}
library(dplyr)
library(ggplot2)
library(lubridate)

# Step 1: Combine Date + Time into POSIXct
df <- realtime_waterlevel_kelani_ganga |>
  filter(HydrometricStation != "Nagalagam Street") |>
  mutate(
    DateTime = ymd_h(paste(Date, Time))
  )

# Step 2: Plot
p1 <- ggplot(df, aes(x = DateTime, y = RiverWaterLevel)) +
  geom_line() +
  geom_point(size=0.3) +
  # Alert, Minor Flood, Major Flood Levels
  geom_hline(aes(yintercept = Alert_level, colour = "Alert Level"), linetype = "dashed") +
  geom_hline(aes(yintercept = Minor_Flood_Level, colour = "Minor Flood Level"), linetype = "dotdash", linewidth = 1) +
  geom_hline(aes(yintercept = Major_Flood_level, colour = "Major Flood Level"), linetype = "solid", linewidth = 1) +

  scale_colour_manual(
    name = "Thresholds",
    values = c(
      "Alert Level" = "#1b9e77",
      "Minor Flood Level" = "#7570b3",
      "Major Flood Level" = "#d95f02"
    )
  ) +

  labs(
    title = "Real-time Hourly River Water Level",
    x = "Date & Time",
    y = paste0("Water Level (", unique(df$RiverWaterLevel_Unit), ")")
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  ) + facet_wrap(vars(HydrometricStation), ncol=6)


p1
```



# Kelani Ganga: Nagalagam Street


Data Source: Hydrology and Disaster Management Division, Irrigation Department, Sri Lanka

```{r, fig.width=15}
# Step 1: Combine Date + Time into POSIXct
df2 <- realtime_waterlevel_kelani_ganga |>
  filter(HydrometricStation == "Nagalagam Street") |>
  mutate(
    DateTime = ymd_h(paste(Date, Time))
  )

# Step 2: Plot
p2 <- ggplot(df2, aes(x = DateTime, y = RiverWaterLevel)) +
  geom_line() +
  geom_point() +
  # Alert, Minor Flood, Major Flood Levels
  geom_hline(aes(yintercept = Alert_level, colour = "Alert Level"), linetype = "dashed") +
  geom_hline(aes(yintercept = Minor_Flood_Level, colour = "Minor Flood Level"), linetype = "dotdash", linewidth = 1) +
  geom_hline(aes(yintercept = Major_Flood_level, colour = "Major Flood Level"), linetype = "solid", linewidth = 1) +
 #   scale_x_datetime(
#    date_breaks = "1 hour",
##    date_labels = "%H:%M"
#  ) +
  scale_colour_manual(
    name = "Thresholds",
    values = c(
      "Alert Level" = "#1b9e77",
      "Minor Flood Level" = "#7570b3",
      "Major Flood Level" = "#d95f02"
    )
  ) +

  labs(
    title = "Real-time Hourly River Water Level",
    x = "Date & Time",
    y = paste0("Water Level (ft)")
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  ) 

ggplotly(p2)
```



# ABOUT

**Dashboard Creator:**

Dr Thiyanga S. Talagala, Department of Statistics, University of Sri jayewardenepura

Contact: ttalagala@sjp.ac.lk

**Data Sources:**

The [Department of Meteorology, Sri Lanka](https://meteo.gov.lk/)

The [Disaster Management Center](https://www.dmc.gov.lk/index.php?option=com_dmcreports&view=reports&Itemid=277&report_type_id=6&lang=en)

**Acknowledgement**

The author gratefully acknowledges the original data providers, the Department of Meteorology, Sri Lanka,  Hydrology and Disaster Management Division, Irrigation Department, Sri Lanka and the Disaster Management Center, whose publicly available weather and disaster-related data support timely community awareness.

**Note:**

Sri Lanka was hit by Diwah on November 28â€“29, 2025, causing widespread damage across the island. The [Department of Meteorology, Sri Lanka](https://meteo.gov.lk/), Hydrology and Disaster Management Division, Irrigation Department, Sri Lanka and the [Disaster Management Center](https://www.dmc.gov.lk/index.php?option=com_dmcreports&view=reports&Itemid=277&report_type_id=6&lang=en)
 published weather data to keep the community informed. This dashboard is created using these publicly available data for educational purposes, weather monitoring, and early warning. As visualizations make complex data easier to understand, the dashboard presents the weather information in graphical form. The author of this dashboard is not affiliated with the data-providing institutions, and these institutions were not involved in dashboard creation. 
